<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Automation Rhapsody" href="https://automationrhapsody.com/rss.xml"><meta name="generator" content="Astro v5.5.3"><script src="/scripts.js"></script><!-- Font preloads --><link rel="stylesheet" property="stylesheet" href="https://fonts.googleapis.com/css?family=Playball"><link rel="stylesheet" property="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter:400,400italic,700"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"><!-- Canonical URL --><link rel="canonical" href="https://automationrhapsody.com/how-to-gather-code-coverage-with-istanbul-and-selenium-and-pitfalls-to-avoid/"><!-- Primary Meta Tags --><title>How to gather code coverage with Istanbul and Selenium and pitfalls to avoid</title><meta name="title" content="How to gather code coverage with Istanbul and Selenium and pitfalls to avoid"><meta name="description" content="Istanbul does not seem to be recoding code coverage correctly, it turned out that the tests do navigation by changing the URL, which resets the code coverage."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://automationrhapsody.com/how-to-gather-code-coverage-with-istanbul-and-selenium-and-pitfalls-to-avoid/"><meta property="og:title" content="How to gather code coverage with Istanbul and Selenium and pitfalls to avoid"><meta property="og:description" content="Istanbul does not seem to be recoding code coverage correctly, it turned out that the tests do navigation by changing the URL, which resets the code coverage."><meta property="og:image" content="https://automationrhapsody.com/blog-placeholder.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://automationrhapsody.com/how-to-gather-code-coverage-with-istanbul-and-selenium-and-pitfalls-to-avoid/"><meta property="twitter:title" content="How to gather code coverage with Istanbul and Selenium and pitfalls to avoid"><meta property="twitter:description" content="Istanbul does not seem to be recoding code coverage correctly, it turned out that the tests do navigation by changing the URL, which resets the code coverage."><meta property="twitter:image" content="https://automationrhapsody.com/blog-placeholder.jpg"><style>:root{--color-gray-bg: #f5f5f5;--color-gray-text: #5e5e5e}body{font-family:Roboto,sans-serif;background:var(--color-gray-bg);word-wrap:break-word;overflow-wrap:break-word;color:var(--color-gray-text);font-size:18px}main{width:960px;max-width:100%;margin:auto}h2{color:#3879d9;font-size:20px;margin:25px 0 6px}p{margin:6px 0}img{max-width:100%}pre{margin:0;padding:12px}.card{padding:16px;margin:10px;box-shadow:0 2px 3px #acabab;background:#fff;border-radius:24px;color:inherit}@media (max-width: 720px){body{font-size:16px}ul{padding-inline-start:16px}}.tab{overflow:hidden;border:1px solid #ccc;background-color:#f1f1f1}.tab button{background-color:inherit;float:left;border:none;outline:none;cursor:pointer;padding:14px 16px;transition:.3s}.tab button:hover{background-color:#ddd}.tab button.active{background-color:#ccc}.tabcontent{display:none;border-top:none}footer[data-astro-cid-sz7xmlte]{margin:24px 0;text-align:center}header[data-astro-cid-3ef6ksr2]{text-align:center;font-size:56px}header[data-astro-cid-3ef6ksr2] div[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{font-family:Playball,Arial;color:#000;text-decoration:none;text-shadow:0 .033em 0 #fff;border-bottom:none}
.post-title[data-astro-cid-bvzihdzo]{font-family:Bitter,serif;font-weight:700!important;margin:0;padding:5px 0;font-size:32px;line-height:40px;color:#444}.tags[data-astro-cid-bvzihdzo]{display:flex;flex-wrap:wrap}.tags[data-astro-cid-bvzihdzo]>a[data-astro-cid-bvzihdzo]{margin-left:8px}@media (max-width: 720px){article[data-astro-cid-bvzihdzo]{padding:12px}}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <div data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2>Automation Rhapsody</a> </div> </header>  <main data-astro-cid-bvzihdzo> <article class="card" data-astro-cid-bvzihdzo> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <h1 class="post-title" data-astro-cid-bvzihdzo>How to gather code coverage with Istanbul and Selenium and pitfalls to avoid</h1> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2021-03-16T00:00:00.000Z"> Mar 16, 2021 </time> </div> <hr data-astro-cid-bvzihdzo> </div>  <p>How to use Istanbul for code coverage of Cypress automated tests was explained in detail in <a href="/testing-with-cypress-custom-logging-of-errors-and-junit-results/">Testing with Cypress – Custom logging of errors and JUnit results</a> post.</p>
<h2>Code coverage with Istanbul and Selenium</h2>
Recently I had to do it again, this time with Selenium. There are several approaches, which can be taken to measure code coverage with Selenium. Whichever approach is taken, the first step is to instrument the frontend. How to do it with React and create-react-app is described in <a href="/testing-with-cypress-build-a-react-application-with-node-js-backend/">Testing with Cypress – Code coverage with Istanbul</a> post. Coverage is present in <em><strong>__coverage__</strong></em> JS frontend variable.
<p>Once the frontend is instrumented, it is important to collect the code coverage after the tests are run. This is where approaches differ. One option is to use <a href="https://github.com/gotwarlost/istanbul-middleware" target="_blank" rel="noopener noreferrer">istanbul-middleware</a>. In this case, a Node.js backend has to be created and the tests should post the coverage results, taken from <strong>coverage</strong> to the backend. I find this approach not convenient, so I took the easier one.</p>
<p>Once the test is finished, the code coverage data is collected and saved as a JSON file in a test results folder, then all the results are used to generate the report. I use C# and the code to do so is as simple as:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>public void CollectCodeCoverage()</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        var data = ((IJavaScriptExecutor)_webDriver)</span></span>
<span class="line"><span>            .ExecuteScript("return window.__coverage__");</span></span>
<span class="line"><span>        if (data != null)</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>            var jsonString = JsonConvert.SerializeObject(data);</span></span>
<span class="line"><span>            var fileName = $"{_testResultsFolder}/coverage_{DateTime.Now.Ticks}.json";</span></span>
<span class="line"><span>            File.WriteAllText(fileName, jsonString);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span></code></pre>
<h2>Generating code coverage report</h2>
The report is generated with the <a href="https://www.npmjs.com/package/nyc" target="_blank" rel="noopener noreferrer">nyc</a> cli tool. Once all the JSON files are copied into a folder with the name <em><strong>.nyc_output</strong></em>, the command to run the report is <em><strong>nyc report --reporter=html</strong></em>. Nyc can be installed as a global NPM package or can be added to the frontend project inside <em><strong>package.json</strong></em>.
<h2>The issues measuring the code coverage</h2>
The setup described above is clear and easy to achieve. Although when tests were run, they did not record coverage, which was supposed to be there. I have spent several days trying to figure out what the issue was. And finally, I was able to understand. In my tests, I use <em><strong>_webDriver.Navigate().GoToUrl()</strong></em>. This actually visits a new URL, basically <em><strong>invalidating all the coverage results gathered so far</strong></em>. Once the problem was identified, the solution was pretty simple - save the cove coverage every time before a new URL is about to get opened.
<h2>Conclusion</h2>
Istanbul is a very good tool to measure the code coverage for web automation tests. In the current post, I have described a pitfall, which should be avoided when using it.  <hr data-astro-cid-bvzihdzo>  <h2 data-astro-cid-bvzihdzo>Related Posts</h2> <ul data-astro-cid-bvzihdzo> <li data-astro-cid-bvzihdzo> <a href="/testing-with-cypress-code-coverage-with-istanbul/" data-astro-cid-bvzihdzo>Testing with Cypress - Code coverage with Istanbul</a> </li> </ul>  <div class="tags" data-astro-cid-bvzihdzo> <div data-astro-cid-bvzihdzo>Tags:</div> <a href="/tags/code-coverage" data-astro-cid-bvzihdzo>Code coverage</a><a href="/tags/javascript" data-astro-cid-bvzihdzo>JavaScript</a><a href="/tags/react" data-astro-cid-bvzihdzo>React</a><a href="/tags/selenium-webdriver" data-astro-cid-bvzihdzo>Selenium WebDriver</a><a href="/tags/web-automation" data-astro-cid-bvzihdzo>Web Automation</a> </div> </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 - Automation Rhapsody. All rights reserved.
</footer>  </body></html>